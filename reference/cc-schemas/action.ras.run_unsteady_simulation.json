{
  "$id": "./action.ras.run_unsteady_simulation.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "unsteady-simulation",
  "description": "Schema for an unsteady HEC-RAS simulation action. Combines action metadata, attribute substitutions, input data sources, outputs, and store configuration.",
  "allOf": [
    {
      "$ref": "#/$defs/Action"
    }
  ],
  "type": "object",
  "additionalProperties": false,
  "required": [
    "name",
    "type",
    "attributes",
    "inputs",
    "outputs",
    "store"
  ],
  "$defs": {
    "Action": {
      "$ref": "./action.json#/$defs/Action"
    },
    "Store": {
      "$ref": "./store.json#/$defs/Store"
    },
    "DataSource": {
      "$ref": "./data.json#/$defs/DataSource"
    }
  },
  "properties": {
    "attributes": {
      "type": "object",
      "description": "Primitive attributes used for template substitution in path strings (accessible via {ATTR::...}).",
      "additionalProperties": {
        "type": [
          "string",
          "number",
          "boolean"
        ]
      },
      "properties": {
        "geom": {
          "type": "string",
          "description": "Geometry identifier suffix (e.g. '01')."
        },
        "plan": {
          "type": "string",
          "description": "Plan identifier (e.g. '01')."
        },
        "modelPrefix": {
          "type": "string",
          "description": "Model prefix used in file names (e.g. 'lavon')."
        },
        "base-hydraulics-directory": {
          "type": "string",
          "description": "Base directory for hydraulics files."
        },
        "base-system-response-directory": {
          "type": "string",
          "description": "Base directory for system-response outputs."
        },
        "outputdir": {
          "type": "string",
          "description": "Top-level output directory name."
        },
        "scenario": {
          "type": "string",
          "description": "Scenario name or folder (e.g. 'conformance')."
        }
      },
      "required": [
        "geom",
        "plan",
        "modelPrefix",
        "base-hydraulics-directory",
        "base-system-response-directory",
        "outputdir",
        "scenario"
      ]
    },
    "inputs": {
      "type": "object",
      "description": "Input set of data_sources required for the unsteady simulation.",
      "properties": {
        "data_sources": {
          "type": "array",
          "description": "An ordered list of input data sources. Each entry is validated against the shared DataSource definition. At least one entry must be the temporary HDF file (with name matching '.*\\.tmp\\.hdf$').",
          "items": {
            "$ref": "#/$defs/DataSource"
          },
          "minItems": 1,
          "allOf": [
            {
              "contains": {
                "type": "object",
                "properties": {
                  "name": {
                    "pattern": ".*\\.tmp\\.hdf$"
                  },
                  "paths": {
                    "type": "object",
                    "properties": {
                      "b_file": {
                        "type": "string",
                        "description": "Path to the HEC-RAS boundary condition file (.b##)."
                      },
                      "o_file": {
                        "type": "string",
                        "description": "Path to HEC-RAS file (.o##)."
                      },
                      "tmp_hdf": {
                        "type": "string",
                        "description": "Path to the HEC-RAS temporary HDF file (.tmp.hdf) used for the unsteady simulation."
                      },
                      "x_file": {
                        "type": "string",
                        "description": "Path to the HEC-RAS file (.x##)."
                      }
                    },
                    "required": [
                      "b_file",
                      "o_file",
                      "tmp_hdf",
                      "x_file"
                    ],
                    "additionalProperties": true
                  }
                },
                "required": [
                  "name",
                  "paths"
                ]
              },
              "minContains": 1
            }
          ],
          "examples": [
            {
              "name": "tmp.hdf",
              "paths": {
                "b_file": "{ATTR::scenario}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/{ATTR::modelPrefix}.b{ATTR::geom}",
                "o_file": "{ATTR::scenario}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/{ATTR::modelPrefix}.ic.o{ATTR::plan}",
                "tmp_hdf": "{ATTR::scenario}/{ATTR::outputdir}/event-data/{ENV::CC_EVENT_IDENTIFIER}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/{ATTR::modelPrefix}.p{ATTR::plan}.tmp.hdf",
                "x_file": "{ATTR::scenario}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/{ATTR::modelPrefix}.x{ATTR::plan}"
              },
              "store_name": "FFRD"
            },
            {
              "name": "failure_elevations.json",
              "paths": {
                "failure_elevations": "{ATTR::scenario}/{ATTR::outputdir}/event-data/{ENV::CC_EVENT_IDENTIFIER}/{ATTR::base-system-response-directory}/failure_elevations.json"
              },
              "store_name": "FFRD"
            }
          ]
        }
      },
      "required": [
        "data_sources"
      ],
      "additionalProperties": false
    },
    "outputs": {
      "type": "object",
      "description": "Output data configuration that includes the specific set of data_sources produced by the unsteady simulation.",
      "properties": {
        "data_sources": {
          "type": "array",
          "description": "An ordered list of output data. Each entry is validated against the shared DataSource definition.",
          "items": {
            "$ref": "#/$defs/DataSource"
          },
          "minItems": 2,
          "allOf": [
            {
              "contains": {
                "type": "object",
                "properties": {
                  "name": {
                    "const": "hdf_output"
                  }
                },
                "required": [
                  "name"
                ]
              },
              "minContains": 1
            },
            {
              "contains": {
                "type": "object",
                "properties": {
                  "name": {
                    "const": "rasoutput_log"
                  }
                },
                "required": [
                  "name"
                ]
              },
              "minContains": 1
            }
          ],
          "examples": [
            {
              "name": "hdf_output",
              "paths": {
                "hdf_output": "{ATTR::scenario}/{ATTR::outputdir}/event-data/{ENV::CC_EVENT_IDENTIFIER}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/{ATTR::modelPrefix}.p{ATTR::plan}.hdf"
              },
              "store_name": "FFRD"
            },
            {
              "name": "rasoutput_log",
              "paths": {
                "rasoutput_log": "{ATTR::scenario}/{ATTR::outputdir}/event-data/{ENV::CC_EVENT_IDENTIFIER}/{ATTR::base-hydraulics-directory}/{ATTR::modelPrefix}/rasoutput.log"
              },
              "store_name": "FFRD"
            }
          ]
        }
      },
      "required": [
        "data_sources"
      ],
      "additionalProperties": false
    },
    "store": {
      "$ref": "#/$defs/Store"
    }
  }
}